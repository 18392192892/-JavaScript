## 第七章：Ajax

@(高性能JavaScript)

Ajax 是高性能`js`的基础，它可以通过异步下载体积很大的文件使得页面加载速度更快。它通过异步的方式在客户端和服务端之间传输数据，从而避免页面资源一起下载。

AJAX 可以显著的改善用户和网站的交互体验。

对于 AJAX 的具体使用方法一样不会赘述，我们只看 AJAX 对与我们有怎样的性能提升，并且如何高性能的去书写 AJAX。

### 一丶数据传输

AJAX 从最基本 的层面来说，是一种与服务器通信而无须重载页面的方法，数据可以从服务器获取或发送给服务器。

其实有多种不同的方法可以建立这种通信通道，每种方法都有各自的**优点**和**限制**。


#### 请求数据

请求数据的方式有很多，本章着重介绍两种：

- XMLHttpRequest（XHR）
- 动态脚本注入

具体的使用方式不做介绍。


#### XMLHttpRequest

XMLHttpRequest 是目前最常用的技术，它允许异步发送和接受数据

对于这个我们已经比较熟悉了，我们现在要讲的是 `Multipart XHR`。

这是一项最新的技术，`multipaert XHR` 允许客户端只有一个 HTTP 请求就可以从服务端向客户端传送**多个资源**。 

它是通过在服务端将资源打包成一个由**双方约定的字符串**分割的长字符串并发送到客户端。然后用 `js` 代码处理这个长字符串，并根据它的 `mime-type` 类型和传入的其他 “头信息” 解析出每个资源。

```javascript
function splitImages(imageString) {
	let imageData = imageString.split('\u0001');
	let imageElement;
	for (let i = 0, len = imageData.length; i < len; i++) {
		imageElement = document.createElement('img');
		imageElement.src = 'data:image/jpeg;base64,' + imageData[i];
		document.getElementById('container').appendChild(imageElement);
	}
}
```
此函数将连续的字符串分解成三段。每一段都是用来创建一个图片元素的。然后将图片元素插入页面种。

图片不是由 base64 字符串转换成二进制，而是使用了 data: URL 的方式创建，并制定 `mime-type` 为 `images/jpeg`。

最终的结果是：在一次 HTTP 请求种向浏览器传送了三张图片。当然也可以一次传送20张，100张图片。

这种方式也可扩展到请求其他的资源，比如 `css`文件，`js`文件。

这样做的好处是减少了 `HTTP` 请求的次数，性能损失相对来说减少了许多。

#### 轮询请求

这样的做法虽然减少了 `HTTP` 请求次数，但是也有问题，因为和并请求，所以一次请求的**体积会越来越大**

因此有必要在每个资源收到时就立刻处理，而不是等到整个响应消息接收完成。这可以通过监听 `readyState` 为 3 的状态来实现。

当 `readyState` 为 3 的状态第一次触发时，启动一个**定时器**，每隔 15ms 检查一次响应中的新数据。数据片段会被收集起来，直到发现一个**分隔符**，然后把遇到分隔符之前收集的所有数据作为一个完整的资源进行处理。

这种方式有一个最大的缺点，就是这种方式获得的资源**无法缓存**。

这是因为合并后的资源是作为**字符串**传输的，然后被 `js` 代码分解成片段。由于**无法用编程的方式向浏览器缓存里注入文件**，因此用这种方式获取的资源无法被缓存

尽管有这个缺点，但在某些情况下 MXHR 依然能显著的提升页面的**整体性能**

### 二丶数据格式

当考虑数据传输技术时，你必须考虑这些因素：功能集，兼容性，性能以及方向。当考虑数据格式时，唯一需要比较的标准就是**速度**。

没有哪种数据格式比其他格式更好，优劣取决于要**传输的数据**以及它在页面上的**用途**，一种可能下载更快，另一种可能解析更快。

#### XML

当 AJAX 最先开始流行时，它选择了 XML 作为数据格式。当时它有很多的优势：极佳的通用性，格式严格，易于验证。那时 JSON 还没有正式作为交换格式，几乎所有服务器语言都有操作 XML 的类库

相比其他格式，XML 及其**冗长**。每个单独的数据片段都依赖**大量结构**，所以**有效数据**的比例非常低。

你必须提前**知道 XML 响应的布局**，然后才能弄清楚它的含义。

种种缺点导致，在高性能 AJAX 中，XML 没有立足之地。


#### JSON

JSON 是一种 JS对象和数组直接量编写的轻量级且易于解析的数据格式。

一般使用 `JSON.parse()` 方法解析字符串本身。

该方法可以捕获 JSON 中的词法错误，并允许你传入一个函数，用来**过滤**或**转换**解析结果。

相对于 XML ，JSON 不论是下载还是解析，都要快很多。

#### JSONP

在使用动态脚本注入时，JSON 数据被当成另一个 `js` 文件并作为原生代码执行。

为了实现这一点，这些数据必须**封装在一个回调函数里**，这就是所谓的 `JSON填充`，也就是 `JSON-P`。

`JSON-P` 的解析耗时为 0，因为它已经是原生格式，所以**无需解析**。

所以 `JSON-P` 比 `JSON` 速度还要快一些

与 XML 相比，JSON 有着许多优点。它有着**体积更小的格式**，在响应信息中**结构所占的比例更小，数据占用的更多**。

它是性能表现最好的数据格式，因为它不仅**传输尺寸小**，而且**解析速度快**。

JSON 是高性能 AJAX 的基础。

#### HTML

HTML 是一种臃肿的数据格式，甚至比 XML 更繁杂。它的优点是，可以直接使用，而不需要消耗 `CPU` 转换成 HTML。

转换 HTML 是需要大量的**字符串操作**，而字符串操作时 `js` 中最慢的部分。

但是下载速度是不及 JSON 快的。  

作为一种数据格式，它很**缓慢**又**臃肿**

#### 自定义格式

理想的数据格式应该只包含**必要的结构**，以便你可以分解出每一个独立的字段。你可以很容易的定义一种这样的格式。

只需要简单地把数据用**分隔符**链接起来。

比如 

```json
Jacho;Alice;Joshua;Matthew;Andrew
```

这些分隔符本质上创建了一个**数据数组**，类似于一个用逗号分割的列表。通过使用不同的分隔符，你可以**创建多维数组**。

这种格式非常简洁，数据/结构的比例相当高，比其他任何格式都高出很多。自定义格式可以**很快速地下载**，且**易于解析**。

客户端接收到自定义格式以后，只需要简单的调用字符串的 `split()` 并传入**分隔符**作为参数即可。

XHR 和 动态脚本注入都可以使用这种格式。两种情况下都要**解析字符串**，因此没有实质性的性能差异。

对于非常大的数据集，它是最快的格式，甚至在**解析速度**和**平均加载时间**上都能击败本地执行的 JSON。

#### 数据格式总结

通常来说数据格式**越轻量级越好**，JSON 和 字符分隔的自定义格式是最好的。如果数据集很大并且对解析时间有要求，那么就从如下两种格式中做出选择：

- JSON-P 数据，使用动态脚本注入获取。它把数据当作可执行 `js` 而不是字符串，**解析速度极快**。
- 字符分隔的自定义格式，使用 XHR 或 动态脚本注入获取，用 `split()`解析。这项技术解析大数据集比 JSON-P 略快。而且通常文件尺寸更小。

所以在我们日常开发中，使用 JSON-P 和 自定义格式是性能最高的。

### 三丶 AJAX 性能指南

选择了合适的**数据传输技术**和**数据格式**以后，就需要考虑其他优化技术了。

#### 缓存数据

最快的 AJAX 请求就是没有请求。有两种方式可以避免发送不必要的请求：
- 在服务端，设置 HTTP 头信息以确保你的响应会被浏览器缓存。
- 在客户端，把获取到的信息存储到本地，从而避免再次请求。

第一种方法使用最简单而且好维护，第二种方式则给你最大的控制权。

#### 设置 HTTP 都信息

具体的缓存过程，这里不赘述了，缓存是一个能快速请求的方式。

#### 本地数据存储

除了依赖**浏览器处理缓存**外，你还可以用更手工的方式来实现，即直接把从服务器接收到的数据**储存**起来。

你可以把响应文本保存到一个对象中，以 URL 为键值对作为索引。

使用本地数据存储相较于浏览器缓存会麻烦一些，但是也有一些优点。

比如在后台数据更新之后，对于前端，手工管理的缓存更容易删除和更改，只需要一句命令就可以删除。而浏览器缓存需要进行一步**协商缓存**才能确认是否可以更改和删除。

而且本地缓存也可以更好的工作在移动设备上。

### 总结

高性能的 AJAX 包括以下方面：选择正确的**数据格式**和与之匹配的**传输技术**

- 对于传输技术，可以使用 **AJAX** 和 **动态脚本注入**
	- AJAX 可以使用 MXHR 来合并请求，一次请求可以包含多个数据，减少请求次数。
	- 动态脚本注入允许**跨域请求**和本地执行 `js` 和 JSON，但是它的接口不是那么安全。
- 对于数据格式总共有四种，XML，JSON，HTML，自定义格式。
	- XML 被广泛应用而且支持良好，但是它十分笨重且解析缓慢。
	- JSON 现在也是一种支持广泛的数据格式，而且是轻量级的，解析速度快。
	- HTML 是一种特殊的格式，这种格式不需要解析，数据请求回来以后可以直接更新 UI。不需要用 `js` 操作字符串。
	- 最后是自定义格式，在解析大量数据集时非常快，但需要编写额外的服务端构造程序，并在客户端解析。
- 在选择了传输技术和数据格式之后，通过缓存也可以**加快请求速度**，缓存可以分为**浏览器缓存**和**本地数据存储**
	- 浏览器缓存是最高效也是最方便的方法，但是如果缓存过期，要修改缓存或删除缓存较为麻烦。
	- 本地数据存储比较麻烦，需要操作 `js` 脚本来实现缓存，但是在缓存过期以后，删除和修改缓存相对来说要简单许多。
 















