## 第二章：数据存取

@(高性能JavaScript)

### 一丶数据存取位置

**数据的存储位置会很大程度上的影响其读取速度**，在 `js` 中，有以下四种基本的数据存取位置

#### 字面量

字面量只代表自身，不存储在特定的位置。`js` 中的字面量有：字符串，数字，布尔值，对象，数组，函数，正则表达式，以及特殊的 `null` 和 `undefined`

#### 本地变量

开发人员使用关键字 `var`，`left`，`const`定义的数据存储单元

#### 数组元素

存储在 `js` 数组对象内部，以数字作为索引

#### 对象成员

存储在 `js` 对象内部，以字符串作为索引

#### 对比
每一种数据存储的位置都有不同的读写消耗。相对来说，**访问数组元素和对象成员的代价高一些**。

总体来说就是**字面量和局部变量的访问速度快于数组项和对象成员的访问速度**。

其实在日常开发中，只有数据量非常大的时候，造成的影响才会显现出来，如果数据很少，不会造成明显的影响。


### 二丶管理作用域

#### 性能影响原因

关于 `js` 的作用域这里不再赘述了。

我们知道，在一个特定的作用域下寻找一个变量会先在自己的变量对象中寻找，如果没有找到会**沿着作用域链向上寻找**，

在函数执行的过程中，每遇到一个变量，都会经历一次**标识解析**过程以决定从哪里获取或存储数据。该过程搜索执行环境的**作用域链**，查找同名的标识符。

在函数执行过程中，每个标识符都要经历这样的搜索过程。**正是这个搜索过程影响了性能。**

#### 标识符解析的性能

标识符解析是有代价的。

在执行环境的作用域链中，**一个标识符所在的位置越深，它的读写速度也就越慢**。

因此，函数中**读写局部变量总是最快的，而读写全局变量通常是最慢的**（因为全局变量在作用域链中的最末端）。

#### 解决标识符解析的性能问题

在没有优化 `js` 引擎的浏览器中，建议尽可能的使用局部变量。

一个好的经验法则是：**如果某个跨作用域的值在函数中被引用了一次以上，那么就把它存储到局部变量里**

#### 改变作用域链

在 `js` 里，有两个语句是可以改变作用域链的

第一个是 `with` 语句。

当代码执行到 `with` 语句时，执行环境的作用域链临时被改变了。**一个新的变量对象被创建**，它包含了参数指定的对象的所有属性。

这个对象被推入了作用域链的首位，**这意味着函数的所有局部变量现在处于第二个作用域链对象中，因此访问的代价更高了。**

因此，最好避免使用 `with` 语句，

除了 `with`，还有 `try-catch` 语句中的 `catch` 子句也具有同样的效果。

在 `catch` 代码块内部，函数所有局部变量将会放在第二个作用域链对象中。

但是`try-chtch` 是一个非常有用的语句，所以在影响不大的时候，完全可以放心使用。

### 三丶闭包的影响

因为作用域链的一些特性，也就明白了为什么闭包会影响性能。

闭包保存的是它的作用域链，所以在使用闭包的时候，会一直向上寻找，也就是说，在使用闭包的时候，其实是一直在**频繁访问跨作用域的标识符，每次访问都会带来性能的损失**

而且，因为一直在访问上层的作用域，所以**之前的作用域也不会销毁**，一直保存着，这也是影响性能的一个问题。

最好小心使用闭包，不过也可以遵循之前说到的解决方法，**将常用的跨作用域变量存储在局部变量中，然后直接访问局部变量**


### 四丶对象成员的影响

之前我们说过，访问对象成员的速度比访问字面量或者变量要慢，这是有原因的。

#### 原型链造成性能问题

原型链也是一条再熟悉不过的链条了。

那么类比作用域链我们就可以知道，在寻找一个对象的属性的时候，也是会沿着**原型链**去寻找的，所以**对象的属性在原型链上存在的位置越深，找到它也就越慢**

每深入一层原型链都会增加性能损失。遍历原型链带来的开销，让性能问题更加严重。

#### 嵌套成员造成性能问题

由于对象成员可以是另一个对象，所以就有了嵌套对象的问题。

例如：`window.location.href`。每次遇到点操作符后，嵌套成员会导致 `js` 引擎搜索所有对象成员，所以结果就不言而喻了。

**对象成员嵌套的越深，读取速度就会越慢**

执行 `location.href` 总要比 `window.location.href`要快

#### 缓存对象成员值

不论是查找原型链造成的性能问题还是嵌套成员造成的性能问题都可以通过**缓存对象成员值**来解决。

方法和作用域链的相同，在同一个函数中没有必要多次读取同一个对象成员，**需要多次读取的对象通过一个局部变量缓存在函数内**

一些位置很深的**方法**或者**属性**，也可以通过局部变量缓存，访问会更快。

### 总结

在 `js` 中，数据存储的位置会对代码整体性能产生重大的影响。数据存储共有四种方法，字面量，变量，数组项，对象成员。

- 访问字面量和局部变量的速度最快，访问数组元素和对象成员速度较慢
- 作用域链会造成性能问题
	- 变量在作用域链中的位置越深，访问所需要的时间越长
	- 全局变量总在作用域的末端，因此访问速度最慢
	- 避免使用 `with` 语句，它可以改变作用域链，加深作用域链的长度影响性能。
- 对象成员会造成性能问题
	- 储存在原型链中的属性或方法位置越深，访问所需要的时间越长
	- 嵌套的对象成员，嵌套越深，访问时间越长
- 作用域链和对象成员造成的性能问题都可以通过**局部变量**解决，在使用前将成员缓存到局部变量中可以显著提升性能




